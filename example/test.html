<!doctype html>
<html>
    <head>
        <title>Upload Test</title>
        <script type="text/javascript" src="jquery.js"></script>
        <script type="text/javascript" src="../lib/webfs.js"></script>
    </head>
    
    <body>
        <form id="u" method="post" action=".">
            <input type="file" id="uploadfile" />
            <br />
            <input type="submit" />
        </form>
        <form id="w" method="post" action=".">
            <input type="text" id="url" size="40" />
            <br />
            <input type="submit" />
        </form>
        <div id="progress"></div>
        
        <ul id="filelist"></ul>
        
        <script type="text/javascript">
        
        var webFS = new WebFS();
        webFS.setFileSystem(webFS.PERSISTENT, 1024, function(error, fs) {
            if (error) {
                throw error;
                return 
            } else {
                
                var getFiles = function() {
                    $('#filelist').html('');
                    webFS.readdir('/', function(error, list) {
                        list.forEach(function(item) {
                            $('#filelist').append('<li><a href="' + item.toURL() + '">' + item.name + '</a></li>');
                        });
                    });
                };
                getFiles();
                
                
                $('#u').submit(function(e) {
                    progressText = '';
                    e.preventDefault();
                    var file = $('#uploadfile')[0].files[0];
                    webFS.openFile(file.fileName, {create: true}, function(error, fileHandler) {
                        webFS.truncate(fileHandler, 0, function(error) {
                            if (error) {
                                throw error;
                                return;
                            }
                            webFS.write(fileHandler, file, null, function(error, endevent) {
                                if (error) {
                                    throw error;
                                    return
                                }
                                getFiles();
                            }, function(progress) {
                                $('#progress').text(progress.loaded + '/' + progress.total);
                            });
                        });
                    });
                    return false;
                });
                
                $('#w').submit(function(e) {
                    progressText = '';
                    e.preventDefault();
                    var url = $('#url').val()
                    webFS.wget(url, function(error, data) {
                        console.log(arguments); 
                    });
                });
                
            }
        });
        
        /**
        webkitRequestFileSystem(TEMPORARY, 1024*1024*1024, function(fileSystemHandler) {
            var fs = new WebFS(fileSystemHandler);
            
            $('#u').submit(function(e) {
                progressText = '';
                e.preventDefault();
                var file = $('#uploadfile')[0].files[0];
            
                fs.writeFile(file.fileName, file, null, function(handler) {
                    console.log(handler);
                }, function(progress) {
                    $('#progress').text(progress.loaded + '/' + progress.total);
                });
                return false;
            });
            
        }, function(error) {
            console.log(error);
        });*/
        
        </script>
    </body>
</html>